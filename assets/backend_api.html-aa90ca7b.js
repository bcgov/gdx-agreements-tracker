import{_ as r,r as i,o as l,c as d,b as e,d as a,e as n,w as c,a as t}from"./app-f7716081.js";const u={},h=t(`<h1 id="gdx-agreements-tracker-api" tabindex="-1"><a class="header-anchor" href="#gdx-agreements-tracker-api" aria-hidden="true">#</a> GDX Agreements Tracker API</h1><h2 id="what-the-api-does" tabindex="-1"><a class="header-anchor" href="#what-the-api-does" aria-hidden="true">#</a> What the API does</h2><ul><li>handles all CRUD operations for the application</li><li>handles all authentication and authorization for the application</li><li>handles all routing for the application</li></ul><h2 id="testing-the-api" tabindex="-1"><a class="header-anchor" href="#testing-the-api" aria-hidden="true">#</a> Testing the API</h2><h3 id="to-run-tests" tabindex="-1"><a class="header-anchor" href="#to-run-tests" aria-hidden="true">#</a> To run tests:</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token builtin class-name">test</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="to-write-tests" tabindex="-1"><a class="header-anchor" href="#to-write-tests" aria-hidden="true">#</a> To Write tests:</h3><p>Many of the codebase&#39;s functions are asynchronous. In order to test them, you&#39;ll need to pass an &quot;async&quot; function as the second argument to <code>it()</code>. Within that function, you&#39;ll need to &quot;await&quot; the function you&#39;re testing. For example:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;tests an asynchronous function&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">functionToTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="to-debug-tests" tabindex="-1"><a class="header-anchor" href="#to-debug-tests" aria-hidden="true">#</a> To debug tests:</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> run test:debug
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="to-get-test-coverage" tabindex="-1"><a class="header-anchor" href="#to-get-test-coverage" aria-hidden="true">#</a> To get test coverage:</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> run test:coverage
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,13),p=e("p",null,"References:",-1),m={href:"https://jestjs.io/",target:"_blank",rel:"noopener noreferrer"},b={href:"https://www.fastify.io/docs/latest/Guides/Testing/#benefits-of-using-fastifyinject",target:"_blank",rel:"noopener noreferrer"},g=t('<h2 id="database" tabindex="-1"><a class="header-anchor" href="#database" aria-hidden="true">#</a> Database</h2><h3 id="connecting" tabindex="-1"><a class="header-anchor" href="#connecting" aria-hidden="true">#</a> Connecting</h3><h4 id="to-connect-to-a-database-gui-tool-during-development-use-the-following-parameters" tabindex="-1"><a class="header-anchor" href="#to-connect-to-a-database-gui-tool-during-development-use-the-following-parameters" aria-hidden="true">#</a> To connect to a database GUI tool during development, use the following parameters:</h4><ul><li>Server host: <code>localhost</code></li><li>Server port: <code>15432</code></li><li>Username: <code>postgres</code></li><li>Password: <code>postgres</code></li></ul>',4),v={href:"/docker-compose.yml",target:"_blank",rel:"noopener noreferrer"},f={href:"/backend/knexfile.js",target:"_blank",rel:"noopener noreferrer"},k=t(`<h3 id="migrations" tabindex="-1"><a class="header-anchor" href="#migrations" aria-hidden="true">#</a> Migrations</h3><h4 id="create-a-new-migration" tabindex="-1"><a class="header-anchor" href="#create-a-new-migration" aria-hidden="true">#</a> Create a new migration:</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> compose <span class="token builtin class-name">exec</span> backend npx knex migrate:make <span class="token operator">&lt;</span>name_of_migration<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="migrate-new-schema-into-the-database" tabindex="-1"><a class="header-anchor" href="#migrate-new-schema-into-the-database" aria-hidden="true">#</a> Migrate new Schema into the Database:</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> compose <span class="token builtin class-name">exec</span> backend npx knex migrate:latest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="reverse-a-migration" tabindex="-1"><a class="header-anchor" href="#reverse-a-migration" aria-hidden="true">#</a> Reverse a migration:</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> compose <span class="token builtin class-name">exec</span> backend npx knex migrate:rollback
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="seeds" tabindex="-1"><a class="header-anchor" href="#seeds" aria-hidden="true">#</a> Seeds</h3><h4 id="create-new-seeds" tabindex="-1"><a class="header-anchor" href="#create-new-seeds" aria-hidden="true">#</a> Create new Seeds:</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>npx knex seed:make <span class="token operator">&lt;</span>name_of_seed<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="execute-all-seeds" tabindex="-1"><a class="header-anchor" href="#execute-all-seeds" aria-hidden="true">#</a> Execute all seeds</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>npx knex seed:run
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><h4 id="database-migrations-that-target-tables-inside-the-data-schema-may-fail-under-some-conditions" tabindex="-1"><a class="header-anchor" href="#database-migrations-that-target-tables-inside-the-data-schema-may-fail-under-some-conditions" aria-hidden="true">#</a> Database migrations that target tables inside the <code>data</code> Schema may fail under some conditions:</h4><ul><li>if they require table structures to already exist before they can be run</li><li>example: <code>Schema.data.projects</code> migrations are run before the <code>data.projects</code> table has been created</li></ul><h4 id="we-need-to-guarantee-that-migrations-on-the-schemas-data-schema-run-in-this-order" tabindex="-1"><a class="header-anchor" href="#we-need-to-guarantee-that-migrations-on-the-schemas-data-schema-run-in-this-order" aria-hidden="true">#</a> We need to guarantee that migrations on the <code>Schemas.data</code> schema run in this order:</h4><ol><li>Migration of new Schema into database</li><li>Migrations of new tables into the existing Schema</li><li>Seeding those tables with data</li></ol></blockquote><h1 id="environment-variables-for-the-backend-api" tabindex="-1"><a class="header-anchor" href="#environment-variables-for-the-backend-api" aria-hidden="true">#</a> Environment Variables for the backend API</h1>`,14),x=e("li",null,"The .env file is not committed to the repo.",-1),y={href:"/backend/sample.env",target:"_blank",rel:"noopener noreferrer"},_={href:"/backend/.env",target:"_blank",rel:"noopener noreferrer"},w={href:"https://console.apps.silver.devops.gov.bc.ca/k8s/ns/acd38d-dev/configmaps/0-gdx-agreements-tracker-api-env-config/yaml",target:"_blank",rel:"noopener noreferrer"},R={href:"https://mykeycloak.com/realms/my-realm/protocol/openid-connect/certs",target:"_blank",rel:"noopener noreferrer"},q=e("h2",{id:"create-a-new-api-endpoints-for-existing-database-tables",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#create-a-new-api-endpoints-for-existing-database-tables","aria-hidden":"true"},"#"),a(" Create a New API Endpoints for existing Database Tables")],-1),P={id:"run-this-script-in-the-backend-directory",tabindex:"-1"},A=e("a",{class:"header-anchor",href:"#run-this-script-in-the-backend-directory","aria-hidden":"true"},"#",-1),T={href:"/backend",target:"_blank",rel:"noopener noreferrer"},I=t(`<div class="language-script line-numbers-mode" data-ext="script"><pre class="language-script"><code>npm run createAPI
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>The cli will prompt you for the {API Name}</li><li>The cli generates the bare minimum files needed to create a new API endpoint:</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>backend/src/controllers/<span class="token punctuation">{</span>API Name<span class="token punctuation">}</span>
backend/src/models/<span class="token punctuation">{</span>API Name<span class="token punctuation">}</span>
backend/src/routes/<span class="token punctuation">{</span>API Name<span class="token punctuation">}</span>
backend/src/validators/<span class="token punctuation">{</span>API Name<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),S={href:"http://localhost:8080/APIName",target:"_blank",rel:"noopener noreferrer"},C=e("blockquote",null,[e("p",null,[a("Note: if you run "),e("code",null,"createAPI"),a(" inside a remote docker container, your API URL may be different.")])],-1),M=t(`<h1 id="using-of-cdogs-and-ches-apis-inside-the-gdx-agreements-tracker-api" tabindex="-1"><a class="header-anchor" href="#using-of-cdogs-and-ches-apis-inside-the-gdx-agreements-tracker-api" aria-hidden="true">#</a> Using of CDOGS and CHES APIs <em>inside</em> the GDX Agreements Tracker API:</h1><h4 id="the-gdx-agreements-tracker-api-uses-the-common-components-with-this-syntax" tabindex="-1"><a class="header-anchor" href="#the-gdx-agreements-tracker-api-uses-the-common-components-with-this-syntax" aria-hidden="true">#</a> The GDX Agreements Tracker API uses the Common Components with this syntax:</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>  const cdogs <span class="token operator">=</span> useCommonComponents<span class="token punctuation">(</span><span class="token string">&quot;{cdogs|ches}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  const result <span class="token operator">=</span> cdogs.api.get<span class="token punctuation">(</span><span class="token string">&#39;/{uri}&#39;</span>, <span class="token assign-left variable">config</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  const result <span class="token operator">=</span> cdogs.api.post<span class="token punctuation">(</span><span class="token string">&#39;/{uri}&#39;</span>, <span class="token assign-left variable">body</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span>, <span class="token assign-left variable">config</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="how-routes-use-roles-to-control-user-edit-read-capabilities" tabindex="-1"><a class="header-anchor" href="#how-routes-use-roles-to-control-user-edit-read-capabilities" aria-hidden="true">#</a> How Routes use Roles to control user Edit/Read Capabilities:</h1><h3 id="the-globally-default-role-for-all-routes-is-pmo-manager-edit-capability" tabindex="-1"><a class="header-anchor" href="#the-globally-default-role-for-all-routes-is-pmo-manager-edit-capability" aria-hidden="true">#</a> The globally default Role for all Routes is <code>PMO-Manager-Edit-Capability</code>:</h3><blockquote><p>see <em>verifyRole()</em> in <a href="./src/facilities/fastify.js">./src/facilities/fastify.js</a></p></blockquote><div class="language-JavaScript line-numbers-mode" data-ext="JavaScript"><pre class="language-JavaScript"><code>  // This sets the DEFAULT Role for ALL Routes globally
  const routeRoleRequired = request.routeConfig?.role ?? &quot;PMO-Manager-Edit-Capability&quot;;

   if (!roles.includes(routeRoleRequired)) {
    const message = \`User doesn&#39;t have required role \${routeRoleRequired}\`;
    request.log.warn(message);
    request.log.debug(roles);
    reply.code(401).send({ message });
  }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="set-a-different-role-for-a-route" tabindex="-1"><a class="header-anchor" href="#set-a-different-role-for-a-route" aria-hidden="true">#</a> Set a different Role for a Route</h3><h3 id="how-to-set-a-different-role-for-a-route" tabindex="-1"><a class="header-anchor" href="#how-to-set-a-different-role-for-a-route" aria-hidden="true">#</a> How to set a different Role for a Route:</h3><p>Set config.role in the <code>fastify.route({ config.role })</code></p><blockquote><p>see example route at <a href="./src/routes/reports/genericRoute.js">./src/routes/reports/genericRoute.js</a></p></blockquote><div class="language-JavaScript line-numbers-mode" data-ext="JavaScript"><pre class="language-JavaScript"><code>    fastify.route({
      method: &quot;GET&quot;,
      url: \`/report/:type\`,
      schema: getReport,
      preHandler: controller.reportHandler,
      handler: controller.getReport,
      config: {
        role: &quot;PMO-Reports-Capability&quot;,
      },
    });
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="the-following-roles-are-available-for-use-in-routes" tabindex="-1"><a class="header-anchor" href="#the-following-roles-are-available-for-use-in-routes" aria-hidden="true">#</a> The following Roles are available for use in Routes:</h4><h6 id="composite-roles-each-composite-role-contains-one-or-more-individual-roles" tabindex="-1"><a class="header-anchor" href="#composite-roles-each-composite-role-contains-one-or-more-individual-roles" aria-hidden="true">#</a> Composite roles - each composite role contains one or more individual Roles</h6><ul><li>PMO-Admin-Role</li><li>PMO-Manager-Role</li><li>PMO-User-Role</li><li>pmo-sys-admin (<em>deprecated - do not use</em>)</li></ul><h6 id="individual-roles-they-determine-what-a-user-can-do" tabindex="-1"><a class="header-anchor" href="#individual-roles-they-determine-what-a-user-can-do" aria-hidden="true">#</a> Individual Roles: they determine what a user can do:</h6><ul><li>PMO-Admin-Edit-Capability</li><li>PMO-Manager-Edit-Capability</li><li>PMO-Manager-Read-Capability</li><li>PMO-Reports-Capability</li></ul><hr><h3 id="troubleshooting" tabindex="-1"><a class="header-anchor" href="#troubleshooting" aria-hidden="true">#</a> Troubleshooting</h3><ul><li>coming soon!</li></ul><h3 id="folder-structure" tabindex="-1"><a class="header-anchor" href="#folder-structure" aria-hidden="true">#</a> Folder structure</h3><ul><li>coming soon!</li></ul>`,22);function E(j,N){const s=i("ExternalLinkIcon"),o=i("RouterLink");return l(),d("div",null,[h,e("blockquote",null,[p,e("ul",null,[e("li",null,[a("Test Runner: "),e("a",m,[a("Jest"),n(s)])]),e("li",null,[a("Test Utilities: "),e("a",b,[a("light-my-request"),n(s)])])])]),g,e("blockquote",null,[e("p",null,[a("If using the "),e("a",v,[a("docker-compose.yml"),n(s)]),a(" file to develop locally, you'll need to populate your database once the containers are up and running. Make sure to run these migrate and seed commands from within the "),n(o,{to:"/guide/Backend/"},{default:c(()=>[a("/backend")]),_:1}),a(" directory so that the knex command can find "),e("a",f,[a("/backend/knexfile.js"),n(s)]),a(".")])]),k,e("ul",null,[x,e("li",null,[a("There is an up to date sample.env file here: "),e("a",y,[a("/backend/sample.env"),n(s)])]),e("li",null,[a("you will need to create your own .env file in the backend directory: ("),e("a",_,[a("/backend/.env"),n(s)]),a(")")]),e("li",null,[a("For the values you will need, look here: "),e("a",w,[a("OpenShift config maps for acd38d-dev"),n(s)]),e("blockquote",null,[e("p",null,[a("note: The JSON Web Key Set (keycloak ) endpoint is: "),e("a",R,[a("https://mykeycloak.com/realms/my-realm/protocol/openid-connect/certs"),n(s)])])])])]),q,e("h3",P,[A,a(" Run this script in the "),e("a",T,[a("/backend"),n(s)]),a(" directory:")]),I,e("ul",null,[e("li",null,[a("Once these files are created, you should have a (locally) working API at: "),e("a",S,[a("http://localhost:8080/{API NAME}"),n(s)]),C])]),M])}const D=r(u,[["render",E],["__file","backend_api.html.vue"]]);export{D as default};
