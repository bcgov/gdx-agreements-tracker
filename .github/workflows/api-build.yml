name: Start API Image Pipeline.
on:
  push:
    branches:
      - development
    paths:
      - "backend/**/*"
      - "openshift/templates/images/api/**/*"
      - "openshift/templates/base-images/node-16.yaml"
      - "!backend/.eslintrc.json"
      - "!backend/docs"
      - "!backend/README.md"

  workflow_dispatch:
defaults:
  run:
    working-directory: ./
jobs:
  deploy_api_on_openshift:
    if: github.repository_owner == 'bcgov'
    runs-on: ubuntu-latest
    steps:
      - name: Install Tekton CLI
        run: |
          curl -LO https://github.com/tektoncd/cli/releases/download/v0.23.0/tkn_0.23.0_Linux_x86_64.tar.gz
          tar xvzf tkn_0.23.0_Linux_x86_64.tar.gz
          sudo mv tkn /usr/local/bin/

      - name: Image Build for gdx-agreements-tracker-api-build
        uses: redhat-developer/openshift-actions@v1.1
        with:
          version: "latest"
          openshift_server_url: ${{ secrets.OpenShiftServerURL }}
          parameters: '{"apitoken": "${{ secrets.OpenShiftToken }}", "acceptUntrustedCerts": "true"}'
          cmd: |
            tkn pipeline start pipeline-gdx-agreements-build-api
